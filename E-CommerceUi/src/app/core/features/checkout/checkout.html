<div class="container mt-5 pt-5 min-vh-100 mb-5">
  <div class="row">
    <div class="col-12">
      <h2 class="fw-bold mb-4 text-dark d-flex align-items-center">
        <i class="fa fa-shopping-bag me-3 text-danger"></i> Checkout
      </h2>
    </div>
  </div>

  @if (loading) {
    <div class="spinner-overlay">
      <div class="text-center">
        <div class="spinner-border text-danger mb-3" role="status"></div>
        <h5 class="fw-bold text-dark">Processing Order...</h5>
        <p class="text-muted small">Please do not close this window</p>
      </div>
    </div>
  }

  <div class="row g-4">
    <div class="col-lg-7">
      <div class="card shadow-sm border-0 p-4 rounded-4 bg-white">
        <h5 class="fw-bold mb-4 border-bottom pb-2">
          <i class="fa fa-truck me-2 text-danger"></i>Shipping Information
        </h5>

        <form [formGroup]="checkoutForm" (ngSubmit)="placeOrder()">
          <div class="mb-4">
            <label class="form-label fw-bold small text-muted text-uppercase"
              >Delivery Address</label
            >
            <textarea
              class="form-control bg-light border-0 p-3"
              formControlName="address"
              rows="3"
              placeholder="Full address: Street, Building, Apartment..."
              [class.is-invalid]="
                checkoutForm.get('address')?.invalid && checkoutForm.get('address')?.touched
              "
            ></textarea>
            <div class="invalid-feedback">Address must be at least 10 characters long.</div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold small text-muted text-uppercase">City</label>
              <select
                class="form-select bg-light border-0 p-3"
                formControlName="city"
                [class.is-invalid]="
                  checkoutForm.get('city')?.invalid && checkoutForm.get('city')?.touched
                "
              >
                <option value="">Select City</option>
                <option value="Cairo">Cairo</option>
                <option value="Giza">Giza</option>
                <option value="Alexandria">Alexandria</option>
                <option value="Mansoura">Mansoura</option>
                <option value="Tanta">Tanta</option>
              </select>
              <div class="invalid-feedback">Please select your city.</div>
            </div>

            <div class="col-md-6 mb-4">
              <label class="form-label fw-bold small text-muted text-uppercase"
                >Receiver Phone</label
              >
              <input
                type="text"
                class="form-control bg-light border-0 p-3"
                formControlName="receiverPhoneNumber"
                placeholder="01xxxxxxxxx"
                [class.is-invalid]="
                  checkoutForm.get('receiverPhoneNumber')?.invalid &&
                  checkoutForm.get('receiverPhoneNumber')?.touched
                "
              />
              <div class="invalid-feedback">Enter a valid Egyptian mobile number.</div>
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold small text-muted text-uppercase">Payment Method</label>
            <div class="d-flex gap-3">
              <div class="payment-option flex-fill">
                <input
                  type="radio"
                  class="btn-check"
                  id="cash"
                  formControlName="paymentMethod"
                  value="Cash"
                />
                <label class="btn btn-outline-danger w-100 p-3 rounded-3" for="cash">
                  <i class="fa fa-money-bill-wave me-2"></i> Cash on Delivery
                </label>
              </div>
              <div class="payment-option flex-fill">
                <input
                  type="radio"
                  class="btn-check"
                  id="card"
                  formControlName="paymentMethod"
                  value="Card"
                />
                <label class="btn btn-outline-secondary w-100 p-3 rounded-3 opacity-50" for="card">
                  <i class="fa fa-credit-card me-2"></i> Card (Soon)
                </label>
              </div>
            </div>
          </div>

          <button
            type="submit"
            class="btn btn-danger btn-lg w-100 py-3 fw-bold mt-2 shadow rounded-pill place-order-btn"
            [disabled]="checkoutForm.invalid || loading"
          >
            CONFIRM ORDER ({{ finalTotal | number: '1.2-2' }} L.E)
          </button>
        </form>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card shadow-sm border-0 p-4 bg-white rounded-4 h-100 d-flex flex-column">
        <h5 class="fw-bold mb-4 text-dark border-bottom pb-2">Order Summary</h5>

        <div class="cart-items-list mb-3 flex-grow-1 custom-scrollbar">
          @for (cartItem of cartProducts; track cartItem.id) {
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center">
                <div class="product-img-container bg-white p-1 rounded-3 me-3 border">
                  <img
                    [src]="'https://localhost:7247' + cartItem.item.imageUrl"
                    class="img-fluid"
                    alt="Product Image"
                  />
                </div>
                <div>
                  <h6 class="mb-0 small fw-bold text-truncate" style="max-width: 150px">
                    {{ cartItem.item.name }}
                  </h6>
                  <span class="text-muted extra-small">Qty: {{ cartItem.quantity }}</span>
                </div>
              </div>
              <div class="text-end">
                <span class="fw-bold small text-dark">
                  {{
                    ((cartItem.item.discountPrice ?? 0) > 0
                      ? cartItem.item.discountPrice!
                      : cartItem.item.price) * cartItem.quantity | number: '1.2-2'
                  }}
                  L.E
                </span>
              </div>
            </div>
          }
        </div>

        <div class="summary-details mt-auto pt-3 border-top">
          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Subtotal</span>
            <span class="fw-bold">{{ total | number: '1.2-2' }} L.E</span>
          </div>

          <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">Shipping</span>
            @if (shippingFee === 0) {
              <span class="fw-bold text-success">FREE</span>
            } @else {
              <span class="fw-bold">{{ shippingFee | number: '1.2-2' }} L.E</span>
            }
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
            <span class="h5 fw-bold mb-0">Grand Total</span>
            <span class="h4 fw-bold text-danger mb-0">{{ finalTotal | number: '1.2-2' }} L.E</span>
          </div>

          @if (total < FREE_SHIPPING_LIMIT) {
            <div
              class="alert alert-soft-warning border-0 rounded-3 small d-flex align-items-center"
            >
              <i class="fa fa-info-circle me-2"></i>
              <span
                >Add <b>{{ FREE_SHIPPING_LIMIT - total | number }} L.E</b> for
                <b>Free Shipping</b></span
              >
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
